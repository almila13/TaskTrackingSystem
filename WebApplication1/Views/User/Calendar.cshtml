@{
    ViewBag.Title = "Calendar";
    var displayName = (Session["DisplayName"] as string) ?? (Session["Username"] as string);
}

<!-- TOPBAR -->
<div id="topbar" class="mb-3 p-3 text-white d-flex align-items-center justify-content-between"
     style="background-color:#a23322;border-radius:16px;">
    <div class="d-flex align-items-center">
        <button id="menuToggle" class="btn btn-link text-white mr-3 p-0" style="font-size:24px;line-height:1;">&#9776;</button>
        <img src="@Url.Content("~/Content/Images/akkon_logo_new.png")" alt="logo" style="height:22px;" class="mr-2" />
        <span class="font-weight-bold mr-3">AkTask</span>
        <span>Welcome, <strong>@username</strong>!</span>
    </div>
    <div class="d-flex align-items-center">
        @Html.ActionLink("Create", "Create", "User", null, new { @class = "btn btn-light text-dark" })
    </div>
</div>

<style>
    /* Topbar’daki butonları düz köşeli yap */
    #topbar .btn,
    #topbar .btn-outline-light,
    #topbar .btn-light,
    #topbar a.btn,
    #topbar button.btn {
        border-radius: 6px !important;
    }

    /* Popover/menü takvimin üstünde kalsın */
    #sidebar {
        overflow: visible;
    }

    .popover {
        z-index: 12000 !important;
    }

    /* === FullCalendar event görselliği (görünür metin) === */
    .fc .fc-daygrid-event {
        border-radius: 6px;
        padding: 2px 6px;
    }

        .fc .fc-daygrid-event .fc-event-title {
            white-space: normal;
            font-weight: 600;
        }

    /* Başlangıç/bitiş renkleri + koyu yazı rengi */
    .fc-event-start {
        background: #FFF7ED !important;
        border-color: #FB923C !important;
        color: #111827 !important;
    }

    .fc-event-end {
        background: #FEF2F2 !important;
        border-color: #F87171 !important;
        color: #111827 !important;
    }

    /* Baloncuk stil */
    #evtBubble .card {
        border-radius: 14px;
        box-shadow: 0 12px 24px rgba(0,0,0,.18);
    }
</style>

<!-- SIDEBAR -->
<div id="sidebar" style="position:fixed;top:0;left:0;height:100vh;width:260px;background:#fff;
     box-shadow:2px 0 12px rgba(0,0,0,.15);transform:translateX(-100%);transition:transform .25s ease;z-index:9999;">
    <div class="p-3 border-bottom d-flex align-items-center" style="background:#a23322;color:#fff;">
        <strong class="mr-2">Menu</strong>
        <span class="ml-auto" id="menuClose" style="cursor:pointer;">✕</span>
    </div>

    <div class="d-flex flex-column" style="height:calc(100vh - 56px);">
        <div class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action" href="@Url.Action("Index","User")">My Tasks</a>
            <a class="list-group-item list-group-item-action" href="@Url.Action("Calendar","User")">Calendar</a>
        </div>

        <div class="mt-auto border-top p-3 d-flex align-items-center">
            <img src="@Url.Action("Avatar","Account")"
                 class="rounded-circle mr-2" style="width:28px;height:28px;object-fit:cover;"
                 onerror="this.onerror=null; this.src='@Url.Content("~/Content/Images/default_avatar.png")';" />
            <button id="profileBtn" type="button" class="btn btn-link p-0 text-dark font-weight-bold">
                @username ▾
            </button>
        </div>

        <div id="profilePopover" class="d-none">
            <div class="list-group">
                <a href="@Url.Action("Profile","Account")" class="list-group-item list-group-item-action">Change profile picture</a>
                <a href="@Url.Action("Logout","Account")" class="list-group-item list-group-item-action text-danger">Logout</a>
            </div>
        </div>
    </div>
</div>

<h2 class="mb-3">Calendar</h2>

<!-- FullCalendar (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<div id="calendar"></div>

@section Scripts{
    <script>
  // --- Sidebar ---
  var sb = document.getElementById('sidebar');
  document.getElementById('menuToggle').onclick = function(){ sb.style.transform = 'translateX(0)'; };
  document.getElementById('menuClose').onclick  = function(){ sb.style.transform = 'translateX(-100%)'; };

  // --- Profil Popover (sidebar içinde) ---
  $('#profileBtn').popover({
    html:true, trigger:'click', placement:'right', container:'#sidebar', sanitize:false,
    content:function(){ return $('#profilePopover').html(); }, title:' '
  });
  $(document).on('click', function (e) {
    if (!$(e.target).closest('.popover, #profileBtn').length) $('#profileBtn').popover('hide');
  });

  // --- FullCalendar init ---
  document.addEventListener('DOMContentLoaded', function () {
    var el = document.getElementById('calendar');
    var editBase = '@Url.Action("Edit","User")';

    var calendar = new FullCalendar.Calendar(el, {
      height: 'auto',
      initialView: 'dayGridMonth',
      headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
      events: '@Url.Action("CalendarEvents","User")', // JSON endpoint
      eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },

      eventDidMount: function(info){
        if(String(info.event.id).indexOf('start_') === 0) info.el.classList.add('fc-event-start');
        if(String(info.event.id).indexOf('end_')   === 0) info.el.classList.add('fc-event-end');
        info.el.style.cursor = 'pointer';
      },

      // Tıklayınca baloncuk aç
      eventClick: function(info){
        info.jsEvent.preventDefault();
        $('#evtBubble').remove(); // varsa kapat

        var e   = info.event;
        var ext = e.extendedProps || {};
        var px  = info.jsEvent.pageX + 12;
        var py  = info.jsEvent.pageY + 12;

        // XSS basit kaçış
        function esc(s){
          return String(s||'').replace(/[&<>"']/g, function(m){
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]);
          });
        }

        var html = `
          <div id="evtBubble" style="position:absolute;left:${px}px;top:${py}px;z-index:13000;min-width:280px;">
            <div class="card">
              <div class="card-body">
                <h6 class="mb-2">Task details</h6>
                <div><b>Title:</b> ${esc(ext.titleText || e.title)}</div>
                <div><b>Start:</b> ${esc(ext.startText || '')}</div>
                <div><b>End:</b> ${esc(ext.endText   || '')}</div>
                ${ext.note ? `<div class="mt-2"><b>Note:</b>
                  <div class="border rounded p-2" style="white-space:pre-wrap;">${esc(ext.note)}</div></div>` : ``}
                ${ext.taskId ? `<a class="btn btn-sm btn-primary mt-3" href="${editBase}/${ext.taskId}">Open task</a>` : ``}
              </div>
            </div>
          </div>`;
        $('body').append(html);
      }
    });

    calendar.render();

    // Dışarı tıklayınca / scroll-resize’da balon kapansın
    $(document).on('click', function(ev){
      if(!$(ev.target).closest('#evtBubble, .fc-event').length) $('#evtBubble').remove();
    });
    $(window).on('scroll resize', function(){ $('#evtBubble').remove(); });
  });
    </script>
}



